name: MetaGPT_Cloud_Task

on:
  workflow_dispatch:
    inputs:
      idea:
        description: '任务需求'
        required: true
        default: '写一个简单的 Python 脚本，随机生成 10 个中奖号码'

jobs:
  run_ai_team:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          # 绕过本地安装，直接安装 requirements 里的所有零件
          pip install -r requirements.txt
          pip install loguru pydantic-settings python-docx

      - name: Run MetaGPT directly
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PYTHONPATH: ${{ github.workspace }} # 强制锁定项目根目录
        run: |
          # 1. 强制生成配置文件
          mkdir -p config
          cat > config/config2.yaml <<EOF
          llm:
            api_type: "gemini"
            api_key: "$GEMINI_API_KEY"
            model: "gemini-1.5-flash"
          EOF
          
          # 2. 直接运行本地的 startup.py 脚本，避开模块识别问题
          echo "正在点火 AI 团队..."
          python3 metagpt/startup.py "${{ github.event.inputs.idea }}" --log-level INFO

      - name: Upload Workspace Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai_generated_code
          path: workspace/
