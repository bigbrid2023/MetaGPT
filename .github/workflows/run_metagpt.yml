name: MetaGPT_Cloud_Task

on:
  workflow_dispatch:
    inputs:
      idea:
        description: '任务需求'
        required: true
        default: '写一个简单的 Python 脚本，随机生成 10 个中奖号码'

jobs:
  run_ai_team:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install All Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install loguru pydantic-settings python-docx pydantic==2.10.1 # 强制指定稳定版本

      - name: Run MetaGPT and Cat Code
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          # 1. 生成配置
          mkdir -p config
          printf "llm:\n  api_type: 'gemini'\n  api_key: '$GEMINI_API_KEY'\n  model: 'gemini-1.5-flash'\n" > config/config2.yaml
          
          # 2. 运行任务，并使用 timeout 确保不会死等
          echo "AI 团队开始协作，请观察下方日志输出..."
          python3 metagpt/startup.py "${{ github.event.inputs.idea }}" --log-level INFO
          
          # 3. 暴力打印：如果生成了目录，直接找出 main.py 并打印到屏幕上
          echo "----------------------------------------"
          echo "检查生成结果："
          if [ -d "workspace" ]; then
            find workspace -name "main.py" -exec echo "找到代码文件: {}" \; -exec cat {} \;
          else
            echo "错误：AI 团队未能在 workspace 目录下产出文件，请检查 API Key 是否有效。"
          fi
          echo "----------------------------------------"

      - name: Upload Workspace Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai_generated_code
          path: workspace/
