name: MetaGPT_Cloud_Task

on:
  workflow_dispatch:
    inputs:
      idea:
        description: '你的任务需求'
        required: true
        default: '写一个简单的 Python 脚本，随机生成 10 个中奖号码'

jobs:
  run_ai_team:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 # 升级到 v4

      - name: Set up Python
        uses: actions/setup-python@v5 # 升级到 v5
        with:
          python-version: '3.9'

      - name: Install MetaGPT
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install loguru pydantic-settings python-docx

      - name: Run MetaGPT with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          mkdir -p ~/.metagpt
          echo "llm:" > ~/.metagpt/config2.yaml
          echo "  api_type: 'gemini'" >> ~/.metagpt/config2.yaml
          echo "  api_key: '$GEMINI_API_KEY'" >> ~/.metagpt/config2.yaml
          echo "  model: 'gemini-1.5-flash'" >> ~/.metagpt/config2.yaml
          python3 -m metagpt.startup "${{ github.event.inputs.idea }}"

      - name: Upload Workspace Results
        uses: actions/upload-artifact@v4 # 核心修正：必须使用 v4
        with:
          name: ai_generated_code
          path: workspace/
